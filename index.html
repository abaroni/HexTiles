<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">

  <title>COVID-19</title>
  <meta content="" name="descriptison">
  <meta content="" name="keywords">

  <!-- Favicons -->
  <link href="assets/img/favicon.png" rel="icon">
  <link href="assets/img/apple-touch-icon.png" rel="apple-touch-icon">

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,600,600i,700,700i|Raleway:300,300i,400,400i,500,500i,600,600i,700,700i|Poppins:300,300i,400,400i,500,500i,600,600i,700,700i" rel="stylesheet">

  <!-- Vendor CSS Files -->
  <link href="assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <link href="assets/vendor/icofont/icofont.min.css" rel="stylesheet">
  <link href="assets/vendor/boxicons/css/boxicons.min.css" rel="stylesheet">
  <link href="assets/vendor/venobox/venobox.css" rel="stylesheet">
  <link href="assets/vendor/aos/aos.css" rel="stylesheet">

  <!-- Template Main CSS File -->
  <link href="assets/css/style.css" rel="stylesheet">

  <!-- =======================================================
  * Template Name: Bocor - v2.0.0
  * Template URL: https://bootstrapmade.com/bocor-bootstrap-template-nice-animation/
  * Author: BootstrapMade.com
  * License: https://bootstrapmade.com/license/
  ======================================================== -->
</head>

<body>

  <!-- ======= Header ======= -->
  <header id="header">
    <div class="container d-flex">

      <div class="logo mr-auto">
        <h1 class="text-light"><a href="index.html">COVID<span>-</span>19</a></h1>
        <!-- Uncomment below if you prefer to use an image logo -->
        <!-- <a href="index.html"><img src="assets/img/logo.png" alt="" class="img-fluid"></a>-->
      </div>

      <nav class="nav-menu d-none d-lg-block">
        <ul>
          <li class="active"><a href="#header">Home</a></li>
          <!--  <li class="get-started"><a href="#about">Get Started</a></li>-->
          <!--
          <li><a href="#services">Services</a></li>
          <li><a href="#portfolio">Portfolio</a></li>
          <li><a href="#team">Team</a></li>
          <li class="drop-down"><a href="">Drop Down</a>
            <ul>
              <li><a href="#">Drop Down 1</a></li>
              <li class="drop-down"><a href="#">Drop Down 2</a>
                <ul>
                  <li><a href="#">Deep Drop Down 1</a></li>
                  <li><a href="#">Deep Drop Down 2</a></li>
                  <li><a href="#">Deep Drop Down 3</a></li>
                  <li><a href="#">Deep Drop Down 4</a></li>
                  <li><a href="#">Deep Drop Down 5</a></li>
                </ul>
              </li>
              <li><a href="#">Drop Down 3</a></li>
              <li><a href="#">Drop Down 4</a></li>
              <li><a href="#">Drop Down 5</a></li>
            </ul>
          </li>

          -->
          <li><a href="#contact">Contact Me</a></li>
        </ul>
      </nav><!-- .nav-menu -->

    </div>
  </header><!-- End Header -->

  <!-- ======= Hero Section ======= -->
  <section id="hero">

    <div class="container">
      <div class="row d-flex align-items-center">
      <div class=" col-lg-6 py-5 py-lg-0 order-2 order-lg-1" data-aos="fade-right">
        <h1>⚠️Warning⚠️</h1>
        <h2>This is not a forecast of how COVID-19 will impact italy. I'm just a kid with some javascript and governament data, not taking into account a lot of things. Please do not share on social media without this warning.</h2>
        <a href="#about" class="btn-get-started scrollto">I understand</a>
      </div>
      <div class="col-lg-6 order-1 order-lg-2 hero-img" data-aos="fade-left">
          <h1>Read the warning</h1>
      </div>
    </div>
    </div>

  </section><!-- End Hero -->

  <main id="main">

    <!-- ======= About Section ======= -->
    <section id="about" class="about section-bg">
      <div class="container">

        <div class="row">
          <div class="col-xl-12 pl-0 pl-lg-5 pr-lg-1 d-flex align-items-stretch">
            <div class="content d-flex flex-column justify-content-center">
              <h3 data-aos="fade-in" data-aos-delay="50">Latest data from: <span id="latest-date"></span></h3>
              <div class="row">
                <div class="col-md-6 icon-box" data-aos="fade-up">
                  <i class="bx bx-receipt"></i>
                  <h4>Today's numbers</h4>
                  <p data-aos="fade-in">Reported COVID-19 cases in Italy:</p>
                  <p data-aos="fade-in">Total <span id="total-number"></span></p>
                  <p data-aos="fade-in">Positive <span id="positive-number"></span></p>
                  <p data-aos="fade-in">Death <span id="dead-number"></span></p>
                  <p data-aos="fade-in">Cured <span id="cured-number"></span></p>
                </div>
                <div class="col-md-6 icon-box" data-aos="fade-up" data-aos-delay="50">
                  <i class="bx bx-images"></i>
                  <h4><a href="#">Charted data up to today</a></h4>

                    <div class="chart-container">
                      <canvas id="todayCanvas"></canvas>
                    </div>

                </div>
                <div class="col-md-12 icon-box" data-aos="fade-up" data-aos-delay="100">
                  <i class="bx bx-images"></i>
                  <h4>Fitting equations to the data of total cases</h4>
                  <p>Linear: <span id="linear-equation"></span> , r^2 = <span id="linear-r2"></span></p>
                  <p>Power: <span id="power-equation"></span> , r^2 = <span id="power-r2"></span></p>
                  <p>Exponential: <span id="exponential-equation"></span> , r^2 = <span id="exponential-r2"></span></p>
                </div>
                <div class="col-md-12 icon-box" data-aos="fade-up" data-aos-delay="100">
                  <i class="bx bx-images"></i>
                  <h4>Data and equations on a chart</h4>
                    <div class="chart-container"  style="padding-right: 15px;">
                      <canvas id="dataEquationsCanvas"></canvas>
                    </div>
                </div>
                <div class="col-md-12 icon-box" data-aos="fade-up" data-aos-delay="100">
                  <i class="bx bx-images"></i>
                  <h4>Fitting equations (restricting to last 7 days)</h4>
                  <p>Linear: <span id="restricted-linear-equation"></span> , r^2 = <span id="restricted-linear-r2"></span></p>
                  <p>Power: <span id="restricted-power-equation"></span> , r^2 = <span id="restricted-power-r2"></span></p>
                  <p>Exponential: <span id="restricted-exponential-equation"></span> , r^2 = <span id="restricted-exponential-r2"></span></p>
                </div>
                <div class="col-md-12 icon-box" data-aos="fade-up" data-aos-delay="100">
                  <i class="bx bx-images"></i>
                  <h4>Data and equations on a chart (restricting to last 7 days)</h4>
                  <div class="chart-container"  style="padding-right: 15px;">
                    <canvas id="dataEquationsRestrictedCanvas"></canvas>
                  </div>
                </div>

              </div>
            </div><!-- End .content-->
          </div>
        </div>

      </div>
    </section><!-- End About Section -->


    <!-- ======= Contact Section ======= -->
    <section id="contact" class="contact section-bg">
      <div class="container">

        <div class="section-title">
          <h2 data-aos="fade-in">Contact</h2>
          <p data-aos="fade-in">I'm Alessandro Baroni, you can reach me to the following contacts</p>
        </div>

        <div class="row">
          <div class="col-lg-12">
            <div class="info-box" data-aos="fade-up">
              <i class="bx bx-map"></i>
              <h3>My address</h3>
              <p>Somewhere in Rome</p>
            </div>
          </div>
          <div class="col-lg-12">

            <div class="row">

              <div class="col-md-6">
                <div class="info-box mt-4" data-aos="fade-up" data-aos-delay="50">
                  <i class="bx bx-envelope"></i>
                  <h3>Email Me</h3>
                  <p>inf.baroni@gmail.com</p>
                </div>
              </div>
              <div class="col-md-6">
                <div class="info-box mt-4" data-aos="fade-up" data-aos-delay="50">
                  <i class="bx bxl-twitter"></i>
                  <h3>Tweet me</h3>
                  <p>@tm86</p>
                </div>
              </div>
            </div>

          </div>


        </div>

      </div>
    </section><!-- End Contact Section -->

  </main><!-- End #main -->

  <!-- ======= Footer ======= -->
  <footer id="footer">

    <div class="footer-top">

      <div class="container" data-aos="fade-up">

        <div class="row  justify-content-center">
          <div class="col-lg-6">
            <h3>COVID-19</h3>
            <p>This page has been created to keep me busy while staying at home. It is not an accurate forecast in any way, so don't use it to take any businsess or public interest decision</p>
          </div>
        </div>


        <div class="social-links">
          <a href="https://twitter.com/tm86" class="twitter"><i class="bx bxl-twitter"></i></a>
          <a href="https://it.linkedin.com/in/alebaroni" class="linkedin"><i class="bx bxl-linkedin"></i></a>
        </div>
      </div>
    </div>

    <div class="container footer-bottom clearfix">
      <div class="copyright">

      </div>
      <div class="credits">
        <!-- All the links in the footer should remain intact. -->
        <!-- You can delete the links only if you purchased the pro version. -->
        <!-- Licensing information: https://bootstrapmade.com/license/ -->
        <!-- Purchase the pro version with working PHP/AJAX contact form: https://bootstrapmade.com/bocor-bootstrap-template-nice-animation/ -->
        Designed by <a href="https://bootstrapmade.com/">BootstrapMade</a>
      </div>
    </div>
  </footer><!-- End Footer -->

  <a href="#" class="back-to-top"><i class="icofont-simple-up"></i></a>

  <!-- Vendor JS Files -->
  <script src="assets/vendor/jquery/jquery.min.js"></script>
  <script src="assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
  <script src="assets/vendor/jquery.easing/jquery.easing.min.js"></script>
  <script src="assets/vendor/php-email-form/validate.js"></script>
  <script src="assets/vendor/isotope-layout/isotope.pkgd.min.js"></script>
  <script src="assets/vendor/venobox/venobox.min.js"></script>
  <script src="assets/vendor/aos/aos.js"></script>

  <!-- Template Main JS File -->
  <script src="assets/js/main.js"></script>
  <script src="assets/js/regression.js"></script>
  <script src="assets/js/ucsv.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.3/Chart.bundle.js" integrity="sha256-8zyeSXm+yTvzUN1VgAOinFgaVFEFTyYzWShOy9w7WoQ=" crossorigin="anonymous"></script>
  <script>
      function fetchFile(path, callback) {
        var httpRequest = new XMLHttpRequest();
        httpRequest.onreadystatechange = function() {
            if (httpRequest.readyState === 4) {
                if (httpRequest.status === 200) {
                    if (callback) callback(httpRequest.responseText);
                }else{
                    callback(null,httpRequest)
                }
            }
        };
        httpRequest.open('GET', path);
        httpRequest.send();
      }

		window.onload = function() {
      const todayCanvas = document.querySelector('#todayCanvas')
      const dataEquationsCanvas = document.querySelector('#dataEquationsCanvas')
      const dataEquationsRestrictedCanvas = document.querySelector('#dataEquationsRestrictedCanvas')

      function roundTicks(value, index, values) {
          return (value > 1000 ||value<-1000)? Math.round(value/1000)+'K':value
      }

      function getLabels(data){
        let lastDate = last(data.dates)
        console.log(data.timeWindow)
        let newArray = new Array(data.timeWindow.length - data.dates.length).fill()
        newArray = newArray.map(function(element){
          let dateObject = new Date(lastDate)
          //mutating dateObject
          dateObject.setDate(dateObject.getDate() +1)
          lastDate = dateObject.toISOString().split('T')[0]
          return lastDate
        })
        return data.dates.concat(newArray)
      }

      function last(array) {
          return array[array.length - 1];
      }


      function drawToday(){
        const ctx = todayCanvas.getContext('2d');
  			const options = {
  				type: 'line',
  				data: {
  					labels: allTimeData.dates,
  					datasets: [{
  						label: 'Total',
  						data: allTimeData.total,
  						borderColor: 'rgba(0, 0, 0,0.8)',
  						fill: false,
              showLine: false
  					}]
  				},
  				options: {
  					responsive: true,
            scales: {
                yAxes: [{
                    ticks: {
                        // Include a dollar sign in the ticks
                        callback: roundTicks
                    }
                }]
            }
  				}
  			};
  			new Chart(ctx, options);
      }
      function drawDataEquations(canvas,data){
        const totalDatapoints = data.total
        const linearDatapoints = data.timeWindow.map(e=> parseInt(data.TF.linear.predict(e)[1]))
        const powerDatapoints = data.timeWindow.map(e=> parseInt(data.TF.power.predict(e)[1]))
        const exponentialDatapoints = data.timeWindow.map(e=> parseInt(data.TF.exponential.predict(e)[1]))
        const labels = getLabels(data)
        const ctx = canvas.getContext('2d');

  			const options = {
  				type: 'line',
  				data: {
  					labels: labels,
  					datasets: [
              {
  						label: 'Total',
  						data: totalDatapoints,
  						borderColor: 'rgba(0, 0, 0,0.8)',
  						fill: false,
              showLine: false
  					},
            {
  						label: 'Linear',
  						data: linearDatapoints,
  						borderColor: 'rgba(80, 80, 150,0.5)',
  						fill: false,
              showLine: true
  					},
            {
  						label: 'Power',
  						data: powerDatapoints,
  						borderColor: 'rgba(80, 150, 80,0.5)',
  						fill: false,
              showLine: true
  					},
            {
  						label: 'Exponential',
  						data: exponentialDatapoints,
  						borderColor: 'rgba(150, 80, 80,0.5)',
  						fill: false,
              showLine: true
  					}]
  				},
  				options: {
  					responsive: true,
            scales: {
                yAxes: [{
                    ticks: {
                        // Include a dollar sign in the ticks
                        callback: roundTicks
                    }
                }]
            }
  				}
  			};
  			new Chart(ctx, options);
      }
      
      let allTimeData = null
      let restrictedData = null

      fetchFile('/assets/data/dpc-covid19-ita-andamento-nazionale.csv',function(data,error){
        const dailyArray = CSV.csvToObject(data)

        const positive = []
        const cured = []
        const dead = []
        const total = []
        const dates= []
        let latest = null
        dailyArray.forEach((item,i) => {
          positive.push([i+1,parseInt(item.totale_attualmente_positivi)])
          dead.push([i+1,parseInt(item.deceduti)])
          cured.push([i+1,parseInt(item.dimessi_guariti)])
          total.push([i+1,parseInt(item.totale_casi)])
          dates.push(item.data.split(' ')[0])
          latest = item
        })

        function forecasts(array, latest_to_consider = array.length,day = FORECAST_TOMORROW, method = regression.exponential ){
          const startIndex = dailyArray.length - latest_to_consider
          const endIndex = dailyArray.length
          const blindDates = dates.map(d => d.split(' ')[0]).slice(startIndex,endIndex)
          let blind = array.slice(startIndex,endIndex)


          let return_object = {
            dates : blindDates,
            dataPoints: blind,
            exponential : regression.exponential(blind,{ precision: 16 }),
            linear :  regression.linear(blind,{ precision: 16 }),
            power: regression.power(blind,{ precision: 16 })
          }
          return return_object

        }

        function getOutputObject(days = total.length){
          const totalForecasts = forecasts(total,days)
          const startingDay = totalForecasts.dataPoints[0][0]
          const finalDay = totalForecasts.dataPoints[totalForecasts.dataPoints.length - 1][0]

          const FUTURE_TIME_WINDOW = 7
          const timeWindow = []
          for(let day = startingDay; day<= finalDay +FUTURE_TIME_WINDOW ; day++){
            timeWindow.push(day)
          }

          return {
            TF : totalForecasts,
            timeWindow: timeWindow,
            dates: totalForecasts.dates,
            latestDate: latest.data.split(' ')[0],
            total:totalForecasts.dataPoints.map(e=>e[1]),
            dead: dead.map(e=>e[1]),
            cured: cured.map(e=>e[1]),
            positive: positive.map(e=>e[1])
          }
        }

        const FORECAST_TOMORROW = dailyArray.length
        const FORECAST_ONE_WEEK = dailyArray.length + 6

        allTimeData = getOutputObject()
        restrictedData = getOutputObject(7)

        document.querySelector('#latest-date').textContent= allTimeData.latestDate

        document.querySelector('#total-number').textContent= last(allTimeData.total)
        document.querySelector('#dead-number').textContent= last(allTimeData.dead)
        document.querySelector('#cured-number').textContent= last(allTimeData.cured)
        document.querySelector('#positive-number').textContent= last(allTimeData.positive)

        document.querySelector('#linear-equation').textContent= allTimeData.TF.linear.string
        document.querySelector('#linear-r2').textContent= allTimeData.TF.linear.r2
        document.querySelector('#power-equation').textContent= allTimeData.TF.power.string
        document.querySelector('#power-r2').textContent= allTimeData.TF.power.r2
        document.querySelector('#exponential-equation').textContent= allTimeData.TF.exponential.string
        document.querySelector('#exponential-r2').textContent= allTimeData.TF.exponential.r2

        document.querySelector('#restricted-linear-equation').textContent= restrictedData.TF.linear.string
        document.querySelector('#restricted-linear-r2').textContent= restrictedData.TF.linear.r2
        document.querySelector('#restricted-power-equation').textContent= restrictedData.TF.power.string
        document.querySelector('#restricted-power-r2').textContent= restrictedData.TF.power.r2
        document.querySelector('#restricted-exponential-equation').textContent= restrictedData.TF.exponential.string
        document.querySelector('#restricted-exponential-r2').textContent= restrictedData.TF.exponential.r2
        drawToday()
        drawDataEquations(dataEquationsCanvas, allTimeData)
        drawDataEquations(dataEquationsRestrictedCanvas, restrictedData)
        //drawDataEquations(dataEquationsCanvas, allTimeData.total, allTimeData.totalForcastedLinear, allTimeData.totalForcastedPower, allTimeData.totalForcastedExponential,getLabels(allTimeData))
        //drawDataEquations(dataEquationsRestrictedCanvas, restrictedData.total, restrictedData.totalForcastedLinear, restrictedData.totalForcastedPower, restrictedData.totalForcastedExponential, getLabels(restrictedData))

      })
		};
	</script>
</body>

</html>
